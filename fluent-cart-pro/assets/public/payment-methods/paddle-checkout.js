class g{constructor(t,a,e,n){this.form=t,this.orderHandler=a,this.data=e,this.paymentArgs=(e==null?void 0:e.payment_args)||{},this.intent=(e==null?void 0:e.intent)||{},this.paymentLoader=n,this.currentOrderData=null,this.$t=this.translate.bind(this)}translate(t){var e;return(((e=window.fct_paddle_data)==null?void 0:e.translations)||{})[t]||t}init(){const t=document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle");if(!t){console.error("Paddle container not found");return}t.innerHTML="";const a=this.form.querySelector(".fluent_cart_payment_methods");a&&(a.style.display="none"),this.initializePaddleSDK().then(()=>{this.createPaddleButton(t),window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_success",{detail:{payment_method:"paddle"}}))}).catch(e=>{console.error("Paddle initialization error:",e),this.displayErrorMessage(t,e.message),window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading_failed",{detail:{payment_method:"paddle"}}))})}async initializePaddleSDK(){var e,n;if(typeof Paddle>"u")throw new Error(this.$t("Paddle SDK is not loaded. Please ensure the Paddle script is included."));const t=(e=this.paymentArgs)==null?void 0:e.client_token,a=((n=this.paymentArgs)==null?void 0:n.mode)==="test"?"sandbox":"production";if(!t||typeof t!="string"||t.trim()===""){const i=this.$t("Paddle client token is missing or invalid.");throw new Error(i)}Paddle.Environment.set(a),Paddle.Initialize({token:t.trim(),eventCallback:i=>{this.handlePaddleEvent(i)}})}createPaddleButton(t){var r,d,s,c;const a=this,e=document.createElement("button");e.id="paddle-pay-button",e.className="paddle-checkout-button",e.innerHTML=((r=this.paymentArgs)==null?void 0:r.paddle_checkout_button_text)||this.$t("Pay with Paddle"),e.style.cssText=`
            width: 100%;
            padding: 12px 24px;
            background: ${((d=this.paymentArgs)==null?void 0:d.paddle_checkout_button_color)||"#1a73e8"};
            color: ${((s=this.paymentArgs)==null?void 0:s.paddle_checkout_button_text_color)||"#fff"};
            border: none;
            border-radius: 6px;
            font-size: ${((c=this.paymentArgs)==null?void 0:c.paddle_checkout_button_font_size)||"16px"};
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s;
            margin-bottom: 10px;
        `,e.addEventListener("mouseenter",()=>{var o;e.style.backgroundColor=((o=this.paymentArgs)==null?void 0:o.paddle_checkout_button_hover_color)||"#1557b0"}),e.addEventListener("mouseleave",()=>{var o;e.style.backgroundColor=((o=this.paymentArgs)==null?void 0:o.paddle_checkout_button_color)||"#1a73e8"}),e.addEventListener("click",async o=>{o.preventDefault(),await a.handlePaddleButtonClick()}),t.appendChild(e);const n=document.createElement("p");n.style.cssText=`
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            color: #666;
        `,n.textContent=this.$t("Secure payment powered by Paddle"),t.appendChild(n);const i=document.getElementById("fct_loading_payment_processor");i&&i.remove()}async handlePaddleButtonClick(){var t,a,e,n,i,r,d,s,c;try{if((t=this.paymentLoader)==null||t.changeLoaderStatus("processing"),typeof this.orderHandler=="function"){const o=await this.orderHandler();if(!o)throw(a=this.paymentLoader)==null||a.changeLoaderStatus(this.$t("Order creation failed")),(e=this.paymentLoader)==null||e.hideLoader(),this.paymentLoader.enableCheckoutButton(),new Error(this.$t("Failed to create order"));await this.openPaddleOverlay(o)}else throw(n=this.paymentLoader)==null||n.changeLoaderStatus(this.$t("Order handler not available")),(i=this.paymentLoader)==null||i.hideLoader(),(r=this.paymentLoader)==null||r.enableCheckoutButton(),new Error(this.$t("Order handler is not properly configured"))}catch(o){(d=this.paymentLoader)==null||d.changeLoaderStatus("Error: "+o.message),(s=this.paymentLoader)==null||s.hideLoader(),(c=this.paymentLoader)==null||c.enableCheckoutButton(),this.displayErrorMessage(document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle"),o.message)}}async openPaddleOverlay(t){var a,e,n,i;try{this.currentOrderData=t;const r=(t==null?void 0:t.response)||t,d=(t==null?void 0:t.data)||{};let s=(r==null?void 0:r.paddle_price_ids)||[];if(!s||s.length===0)throw new Error(this.$t("No Paddle price IDs found in order data. Please ensure Paddle products are properly configured."));const c=s.map(l=>({priceId:l.price_id||l.priceId,quantity:parseInt(l.quantity)||1}));if(!c||c.length===0)throw new Error(this.$t("Failed to prepare valid Paddle items from order data."));const o={settings:{displayMode:"overlay",variant:"multi-page",theme:((a=this.intent)==null?void 0:a.theme)||"light",locale:((e=this.intent)==null?void 0:e.locale)||"en",showAddDiscounts:!1},items:c,customData:{fct_order_hash:((n=d==null?void 0:d.order)==null?void 0:n.hash)??"",fct_transaction_hash:((i=d==null?void 0:d.transaction)==null?void 0:i.hash)??""}};d!=null&&d.subscription&&(o.customData.fct_subscription_hash=d.subscription.hash??""),d!=null&&d.customer&&(o.customer=d.customer),r!=null&&r.paddle_discount_id&&(o.discountId=r==null?void 0:r.paddle_discount_id),this.paddleCheckout=Paddle.Checkout.open(o)}catch(r){throw console.error("Error opening Paddle overlay:",r),r}}handlePaddleEvent(t){var n;const a=t.name,e=t.data;switch(a){case"checkout.completed":this.handlePaddlePaymentSuccess(e);break;case"checkout.closed":this.handlePaddleCheckoutClosed(e);break;case"checkout.payment.initiated":(n=this.paymentLoader)==null||n.changeLoaderStatus("processing payment");break;case"checkout.payment.failed":this.handlePaddlePaymentFailed(e);break;case"checkout.items.updated":this.handlePaddleItemsUpdated(e);break;case"checkout.error":this.handlePaddleError(e);break;default:console.log("Unhandled Paddle event:",a,e)}}handlePaddleItemsUpdated(t){}async handlePaddlePaymentSuccess(t){var a,e,n,i;try{(a=this.paymentLoader)==null||a.changeLoaderStatus("confirming");const r=t==null?void 0:t.transaction_id,d=t==null?void 0:t.id;if(!r){(e=this.paymentLoader)==null||e.changeLoaderStatus(this.$t("Error: Missing transaction ID"));return}const s=t.custom_data,c=new URLSearchParams({action:"fluent_cart_confirm_paddle_payment",vendor_charge_id:r,checkout_id:d||"",fct_order_hash:s!=null&&s.fct_order_hash?s==null?void 0:s.fct_order_hash:"",fct_transaction_hash:s!=null&&s.fct_transaction_hash?s==null?void 0:s.fct_transaction_hash:"",totals:JSON.stringify(t.totals),total:(n=t.totals)==null?void 0:n.total}),o=new XMLHttpRequest;o.open("POST",window.fluentcart_checkout_vars.ajaxurl,!0),o.setRequestHeader("Content-Type","application/x-www-form-urlencoded"),o.onload=()=>{var l,p,m,y,_;if(o.status>=200&&o.status<300)try{const h=JSON.parse(o.responseText);h!=null&&h.redirect_url?(this.paymentLoader.triggerPaymentCompleteEvent(h),(l=this.paymentLoader)==null||l.changeLoaderStatus("redirecting"),window.CheckoutHelper?window.CheckoutHelper.handleCheckoutRedirect(h.redirect_url):window.location.href=h.redirect_url):((p=this.paymentLoader)==null||p.changeLoaderStatus(this.$t("Confirmation failed")),(m=this.paymentLoader)==null||m.hideLoader())}catch(h){(y=this.paymentLoader)==null||y.changeLoaderStatus("Error: "+h.message)}else(_=this.paymentLoader)==null||_.changeLoaderStatus(this.$t("Confirmation failed"))},o.onerror=()=>{var l;(l=this.paymentLoader)==null||l.changeLoaderStatus(this.$t("Network error"))},o.send(c.toString())}catch(r){(i=this.paymentLoader)==null||i.changeLoaderStatus(this.$t("Error: %s",r.message))}}handlePaddleCheckoutClosed(t){var a,e,n;if(t.status==="completed")return this.handlePaddlePaymentSuccess(t);(a=this.paymentLoader)==null||a.changeLoaderStatus("canceled"),(e=this.paymentLoader)==null||e.hideLoader(),(n=this.paymentLoader)==null||n.enableCheckoutButton()}handlePaddlePaymentFailed(t){var e,n,i,r;(e=this.paymentLoader)==null||e.changeLoaderStatus(this.$t("Payment failed")),(n=this.paymentLoader)==null||n.hideLoader(),(i=this.paymentLoader)==null||i.enableCheckoutButton();const a=((r=t==null?void 0:t.error)==null?void 0:r.message)||this.$t("Payment failed");this.displayErrorMessage(document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle"),a)}handlePaddleError(t){var e,n,i,r;(e=this.paymentLoader)==null||e.changeLoaderStatus(this.$t("Error occurred")),(n=this.paymentLoader)==null||n.hideLoader(),(i=this.paymentLoader)==null||i.enableCheckoutButton();const a=((r=t==null?void 0:t.error)==null?void 0:r.message)||this.$t("An error occurred. Please try again.");this.displayErrorMessage(document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle"),a)}displayErrorMessage(t,a){const e=document.createElement("div");e.style.color="red",e.className="fc-error-message",e.textContent=a,t.appendChild(e)}}window.addEventListener("fluent_cart_load_payments_paddle",function(u){window.dispatchEvent(new CustomEvent("fluent_cart_payment_method_loading",{detail:{payment_method:"paddle"}}));const t=document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle");t&&(t.innerHTML='<div id="fct_loading_payment_processor">Loading Paddle...</div>'),fetch(u.detail.paymentInfoUrl,{method:"POST",headers:{"Content-Type":"application/json","X-WP-Nonce":u.detail.nonce},credentials:"include"}).then(async e=>{e=await e.json(),new g(u.detail.form,u.detail.orderHandler,e,u.detail.paymentLoader).init()}).catch(e=>{var r;const n=((r=window.fct_paddle_data)==null?void 0:r.translations)||{};function i(d){return n[d]||d}a(i("An error occurred while loading Paddle."))});function a(e){const n=document.querySelector(".fluent-cart-checkout_embed_payment_container_paddle");n&&(n.innerHTML=`
            <div style="color: red; padding: 15px; border: 1px solid #ddd; border-radius: 4px; background: #ffeaea;">
                <strong>Error:</strong> ${e}
            </div>
        `)}});
